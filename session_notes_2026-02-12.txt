== Session Notes 2026-02-12 ==

=== Summary ===

This session implemented three features from instructions.txt, fixed a fundamental
design flaw in the motion band filter, researched external beat detection resources,
and documented ideas for leveraging higher frequency bands.

=== Changes Made ===

1. TIME-BASED AUTO-ALIGN (main.py)
   - Replaced tick-counting auto-align with wall-clock timer approach
   - Old: counted consecutive stable display ticks (QSpinBox 2-10 int "stable readings")
   - New: uses time.time() with configurable seconds (QDoubleSpinBox 1.0-8.0s, step 0.5)
   - Default: 3.0s stability required before adjusting target BPM
   - Added 0.8s cooldown between consecutive ±1 BPM steps
   - State vars: _auto_align_stable_since, _auto_align_is_stable,
     _auto_align_required_seconds, _auto_align_cooldown
   - Handler: _on_auto_align_seconds_change (replaces _on_auto_align_checks_change)

2. PER-BEAT MOTION BAND FILTER (audio_engine.py, stroke_mapper.py, config.py)
   - Added fired_bands field to BeatEvent dataclass (list of z-score bands that
     actually fired on THIS specific beat, not the global primary)
   - Populated at BeatEvent creation: [n for n,s in _band_zscore_signals.items() if s==1]
   - Added motion_freq_cutoff config field (default 500.0 Hz)
   - Filter in stroke_mapper.process_beat() checks if ANY fired band has lower Hz
     below the cutoff; beats with only high-frequency bands are suppressed
   - Classic-path beats (empty fired_bands) always pass through
   - Global _primary_beat_band kept for volume/speed scaling (unchanged)

   WHY: The original approach used event.beat_band (global primary) to filter,
   but that labels ALL beats with whichever band dominates overall. When mid-range
   dominated, every beat was labeled 'mid' and the filter blocked everything.
   Per-beat fired_bands fixes this by checking what actually triggered each beat.

3. MOTION CUTOFF SPINBOX (main.py)
   - QSpinBox in Levels group: 60-2000 Hz, step 20, suffix " Hz", default 500
   - Handler: _on_motion_freq_cutoff_change
   - Initially tried 60-300 range but was too narrow; widened to 60-2000

4. 1 BPM PRECISION RULE (AGENT_REFERENCE.md)
   - Added "Key Design Principles" section with "1 BPM Precision Matters" rule
   - bREadbeats is an auto-adjusting metronome, not just a visualizer
   - 1 BPM error causes visible dot drift over a few measures

5. HIGHER BAND IDEAS & RESEARCH (higher_band_ideas_and_research.txt)
   - Documented 4 band ideas: mid→depth/jitter, high→P1/C0, density→creep, flux scaling
   - Researched 5 external resources: CNN tempo detection, signal correlation,
     Tkinter metronome, metronome challenge, tempoligner
   - Most applicable: autocorrelation-based BPM cross-check

=== Commits ===

- 88f2204: "Add per-beat motion band filter with fired_bands, time-based auto-align,
  1BPM precision rule" (pushed to main)

=== Files Modified ===

- config.py: added motion_freq_cutoff field
- audio_engine.py: added fired_bands to BeatEvent, populated at event creation
- stroke_mapper.py: added per-beat motion filter with _BAND_LOWER_HZ lookup
- main.py: time-based auto-align, QDoubleSpinBox for stability seconds,
  motion cutoff spinbox and handler
- AGENT_REFERENCE.md: added 1 BPM precision rule

=== Files Created ===

- higher_band_ideas_and_research.txt: band ideas and research notes
- session_notes_2026-02-12.txt: this document

=== Key Design Decisions ===

- fired_bands is populated only when is_beat=True (empty list otherwise)
- Classic-path beats (no z-score involvement) have empty fired_bands and pass
  through the motion filter unconditionally — backward compatible
- beat_band (global primary) still used for _get_band_volume() and
  _get_band_duration_scale() since those should track dominant instrument
- Auto-align cooldown (0.8s) prevents rapid oscillation when BPM hovers near target
- Time-based stability is more intuitive than tick-counting for user configuration

=== Notes for Next Agent ===

- The higher_band_ideas_and_research.txt has actionable ideas not yet implemented
- Autocorrelation-based BPM cross-check is the most promising research finding
- Motion filter works well now but spinbox range (60-2000) may need user feedback
- Auto-align seconds spinbox (1.0-8.0s) may need tuning based on real usage
